---
title: "annotations post re-cluster"
author: "Kimberly Olney, PhD"
date: "03/19/2025"
output:
  html_document:
    theme: cerulean
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: inline
---


```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "/tgen_labs/jfryer/kolney/LBD_CWOW/LBD_snRNA/scripts/")
setwd("/tgen_labs/jfryer/kolney/LBD_CWOW/LBD_snRNA/scripts/")
```

# Libraris, paths, colors
```{r echo=FALSE, message=FALSE}
source(here::here("/tgen_labs/jfryer/kolney/LBD_CWOW/LBD_snRNA/scripts/", "file_paths_and_colours.R"))
projectID <- "CWOW_cellbender_after_recluster_harm_int"
color.panel <- dittoColors()
```

# Read in object
```{r read_object}
# read object
dataObject <- readRDS(paste0("../rObjects/",projectID,".rds"))

# inspect
dataObject
```
```{r}
# Remove sample
metadata <- subset(metadata, Sample_ID != "LBD_AS_F4")
metadata$sampleID <- factor(metadata$Sample_ID, levels = c(metadata$Sample_ID))
samples <- metadata$sampleID 
sex_order <- factor(metadata$sex_inferred, levels = unique(metadata$sex_inferred))
disease_order <- factor(metadata$TYPE, levels = c("CONTROL", "AD_AT", "LBD_S", "LBD_AS", "LBD_ATS"))

metadata <- metadata %>%
  mutate(sampleID = gsub(".*_(\\d+)_.*_(BR_Nuclei).*", "\\2_\\1", Lane.Name))
samples <- metadata$sampleID 

# sampleID with disease_order
order <- metadata %>%
  arrange(disease_order) %>%
  dplyr::select(TYPE, sampleID, Sample_ID)
write.table(order, "order.txt", quote = F, row.names = F, sep = "\t")
samples <- order$sampleID
disease_order <- order$TYPE
sample_order <- factor(order$Sample_ID, levels = order$Sample_ID)
```

# Change indents
```{r change_idents}
barcodes <- colnames(dataObject)
sample <- str_match(barcodes, "(.+)_[ACGT]+")[,2]
table(sample)
unique(sample)
dataObject$sample <- factor(sample) #, levels = samples)
table(dataObject$sample)  # check
Idents(dataObject) <- dataObject$sample
```

Add condition column to metadata
```{r condition_column}
# Match the samples to the dataObject
sample_match <- match(dataObject$sample, samples)

# Sex 
dataObject$sex <- sex_order[sample_match]
table(dataObject$sex) 

# Type
dataObject$group <- disease_order[sample_match]
table(dataObject$group) 

dataObject$Sample_ID <- sample_order[sample_match]
table(dataObject$Sample_ID) 
```

# Number of nuclie per sample
```{r number_cells}
# Visualize the number of cell counts per sample
data <- as.data.frame(table(dataObject$Sample_ID))
colnames(data) <- c("Sample_ID","frequency")

ncells <- ggplot(data, aes(x = Sample_ID, y = frequency, fill = Sample_ID)) + 
  geom_col() +
  theme_classic() +
  geom_text(aes(label = frequency), 
            position=position_dodge(width=0.9), 
            #vjust=-0.25, 
            hjust = -.025,
            angle = 90) +
  #scale_fill_manual(values = sample_colors) + 
  scale_y_continuous(breaks = seq(0,30000, by = 5000), limits = c(0,30000)) +
  ggtitle("Filtered: nuclei per sample") +
  theme(legend.position =  "none") + 
  theme(axis.text.x = element_text(angle = 45, hjust=1))
path <- paste0("../results/nuclei_count/",projectID, 
               "_cells_per_sample")
ncells
saveToPDF(paste0(path, ".pdf"), width = 12, height = 4)

# mean cell count 
mean(data$frequency)

# median cell count 
median(data$frequency)
```

# UMAP by group and sample
```{r dimplot1}
DimPlot(dataObject,
        group.by = "group")

DimPlot(dataObject,
        group.by = "Sample_ID")
```

# Unannotated 
### UMAP
```{r unannotated_umap}
ditto_umap <- dittoDimPlot(object = dataObject,
             var = "seurat_clusters",
             do.label = TRUE,
             labels.highlight = TRUE)
ditto_umap
pdf(
  paste0(
    "../results/UMAP/unannotated/",
    projectID,
    ".pdf"
  ),width = 10, height = 8)
ditto_umap
dev.off()
```

### Nuclei count per cluster
```{r count_per_cluster}
Idents(dataObject) <- dataObject$seurat_clusters
count_per_cluster <- FetchData(dataObject,
                               vars = c("ident", "orig.ident")) %>%
  dplyr::count(ident, orig.ident) %>%
  tidyr::spread(ident, n)
count_per_cluster

count_melt <- reshape2::melt(count_per_cluster)
colnames(count_melt) <- c("ident", "cluster", "number of nuclei")
count_max <- count_melt[which.max(count_melt$`number of nuclei`), ]
count_max_value <- count_max$`number of nuclei`
cellmax <- count_max_value + 2000 # so that the figure doesn't cut off the text
count_bar <- ggplot(count_melt, aes(x = factor(cluster), y = `number of nuclei`, fill = `ident`)) +
  geom_bar(
    stat = "identity",
    colour = "black",
    width = 1,
    position = position_dodge(width = 0.8)
  ) +
  geom_text(
    aes(label = `number of nuclei`),
    position = position_dodge(width = 0.9),
    vjust = -0.25,
    angle = 45,
    hjust = -.01
  ) +
  theme_classic() + 
  #scale_fill_manual(values = sample_colors) +
  ggtitle("Number of nuclei per cluster") +  xlab("cluster") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(limits = c(0, cellmax))
count_bar
```

### Cluster tree
```{r cluster_tree}
dataObject <- BuildClusterTree(
  object = dataObject,
  dims = 1:30,
  reorder = FALSE,
  reorder.numeric = FALSE
)

tree <- dataObject@tools$BuildClusterTree
tree$tip.label <- paste0("Cluster ", tree$tip.label)
nClusters <- length(tree$tip.label)

path <- paste0("../results/tree/",projectID,
               "_UMAP_unannotated")
pdf(paste0(path, ".pdf"), width = 6, height = 10)
tree_graph <- ggtree::ggtree(tree, aes(x, y)) +
  scale_y_reverse() +
  ggtree::geom_tree() +
  ggtree::theme_tree() +
  ggtree::geom_tiplab(offset = 1) +
  ggtree::geom_tippoint(color = color.panel[1:nClusters],
                        shape = 16,
                        size = 5) +
  coord_cartesian(clip = 'off') +
  theme(plot.margin = unit(c(0, 2.5, 0, 0), 'cm'))
tree_graph
dev.off()
```



## Markers per cluster
```{r find_all_markers, eval=FALSE}
markers <- SeuratWrappers::RunPrestoAll(
  object = dataObject,
  assay = "RNA",
  slot = "counts",
  only.pos = FALSE
)
write.table(markers, 
            paste0("../results/markers/", projectID, "_markers.tsv"),
            quote = FALSE,
            row.names = FALSE)
saveRDS(markers, paste0("../rObjects/", projectID, "_markers.rds"))
markers <- readRDS(paste0("../rObjects/", projectID,"_markers.rds"))

# rearrange to order by cluster & filter to only include log2FC > 1 & FDR < 0.05
 all.markers.strict <- markers %>%
   group_by(cluster) %>%
   dplyr::filter(avg_log2FC > 1 & p_val_adj < 0.05)

saveRDS(all.markers.strict, paste0("../rObjects/", projectID,"_markers_log2FC1_q0.01.rds"))
all.markers.strict <- readRDS(paste0("../rObjects/", projectID,"_markers_log2FC1_q0.01.rds"))
```

```{r load_markers}
markers <- readRDS(paste0("../rObjects/", projectID,"_markers.rds"))
all.markers.strict <- readRDS(paste0("../rObjects/", projectID,"_markers_log2FC1_q0.01.rds"))
```

# Dot plot
```{r dot_plot}
Idents(dataObject) <- factor(dataObject$seurat_clusters, 
                                     levels = as.character(sort(as.numeric(levels(factor(dataObject$seurat_clusters))))))

levels(Idents(dataObject))
markers.to.plot <-
  c(
    "CLU", 
    "GFAP", 
    "AQP4", 
    "GJA1",
    "CLDN5",
    "ADGRF5",
    "FLT1",
    "COL1A1",
    "COL1A2",
    "DCN",
    "HEXB",
    "C1QA",
    "C1QB",
    "C1QC",
    "ITGAM",
    "TYROBP",
    "P2RY12",
    "AIF1",
    "RBFOX1",
    "RBFOX3", 
    "SNAP25",
    "SYT1",
    "GAD1",
    "GAD2",
    "PLP1",
    "MBP", 
    "MOG", 
    "OLIG1",
    "PDGFRA",
    "VCAN",
    "TNR",
    "ACTA2",
    "VTN"
  )

dot_ind_celltype <- DotPlot(dataObject,
                            features = markers.to.plot, 
                            cluster.idents = FALSE,
                            dot.scale = 8) + RotatedAxis()
dot_ind_celltype
pdf(
  paste0(
    "../results/dot_plot/",
    projectID,
    ".pdf"
  ),width = 10, height = 14)
dot_ind_celltype
dev.off()
```

# Get markers for each cluster
```{r markers_per_cluster}
# unique clusters variable
unique_clusters <- unique(markers$cluster)

# empty list to store individual cluster data frames
cluster_list <- list()

# loop through each cluster and create a data frame
for (i in unique_clusters) {
  cluster_name <- paste0("cluster", i)
  cluster_data <- all.markers.strict[all.markers.strict$cluster == i, ]
  assign(cluster_name, cluster_data)
  cluster_list[[cluster_name]] <- cluster_data
}
```

## Feature plot
```{r featureplot}
# UMAP showing the expression of select features
umap_feature <-
  FeaturePlot(dataObject,
              reduction = "umap",
              features = c("TYROBP", "MOG", "AQP4", "RBFOX3"))
umap_feature

path <- paste0("../results/UMAP/unannotated/",projectID,
               "_UMAP_unannotated_celltype_markers")
umap_feature
saveToPDF(paste0(path, ".pdf"), width = 12, height = 12)
```

# Cluster Annotation

## Cluster 0 - oligo
```{r cluster0}
# Number of cells per condition
count_per_cluster[,c(1,2)]
# UMAP with only cluster 0
DimPlot(object = subset(dataObject, seurat_clusters == "0"),
        reduction = "umap", 
        label = TRUE,
        label.box = TRUE,
        label.size = 3,
        repel = TRUE,
        cols = color.panel[1])
VlnPlot(dataObject,
        features = cluster0$gene[1:10],
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
cluster0$gene[1:10]
```

## Cluster 1 - oligo
```{r cluster1}
count_per_cluster[,c(1,3)]
DimPlot(object = subset(dataObject, seurat_clusters == "1"),
        reduction = "umap", 
        label = TRUE,
        label.box = TRUE,
        label.size = 3,
        repel = TRUE,
        cols = color.panel[2])
VlnPlot(dataObject,
        features = cluster1$gene[1:10],
        cols = color.panel,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
cluster1$gene[1:10]

FeaturePlot(object = subset(dataObject, seurat_clusters == "1"),
              reduction = "umap",
              features = c("TYROBP", "MOG", "AQP4", "RBFOX3"))

```

## Cluster 2 - oligo
```{r cluster2}
count_per_cluster[,c(1,4)]
DimPlot(object = subset(dataObject, seurat_clusters == "2"),
        reduction = "umap", 
        label = TRUE,
        label.box = TRUE,
        label.size = 3,
        repel = TRUE,
        cols = color.panel[3])
VlnPlot(dataObject,
        features = cluster2$gene[1:10],
        cols = color.panel,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
cluster2$gene[1:10]
```

## Cluster 3 - astrocyte
```{r cluster3}
count_per_cluster[,c(1,4)]
DimPlot(object = subset(dataObject, seurat_clusters == "3"),
        reduction = "umap", 
        label = TRUE,
        label.box = TRUE,
        label.size = 3,
        repel = TRUE,
        cols =  color.panel[4])
VlnPlot(dataObject,
        features = cluster3$gene[1:10],
        cols = color.panel,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
cluster3$gene[1:10]
```

## Cluster 4 - opc, with neuron noise
```{r cluster4}
count_per_cluster[,c(1,5)]
DimPlot(object = subset(dataObject, seurat_clusters == "4"),
        reduction = "umap", 
        label = TRUE,
        label.box = TRUE,
        label.size = 3,
        repel = TRUE,
        cols = color.panel[5])
VlnPlot(dataObject,
        features = cluster4$gene[1:10],
        cols = color.panel,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
cluster4$gene[1:10]
```

## Cluster 5 - microglia
```{r cluster5}
count_per_cluster[,c(1,6)]
DimPlot(object = subset(dataObject, seurat_clusters == "5"),
        reduction = "umap", 
        label = TRUE,
        label.box = TRUE,
        label.size = 3,
        repel = TRUE,
        cols = color.panel[6])
VlnPlot(dataObject,
        features = cluster5$gene[1:10],
        cols = color.panel,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
cluster5$gene[1:10]
```

## Cluster 6 - oligo
```{r cluster6}
count_per_cluster[,c(1,7)]
DimPlot(object = subset(dataObject, seurat_clusters == "6"),
        reduction = "umap", 
        label = TRUE,
        label.box = TRUE,
        label.size = 3,
        repel = TRUE,
        cols = "#CC79A7")
VlnPlot(dataObject,
        features = cluster6$gene[1:10],
        cols = color.panel,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
cluster6$gene[1:10]
```

## Cluster 7 - oligo
```{r cluster7}
count_per_cluster[,c(1,8)]
DimPlot(object = subset(dataObject, seurat_clusters == "7"),
        reduction = "umap", 
        label = TRUE,
        label.box = TRUE,
        label.size = 3,
        repel = TRUE,
        cols = color.panel[8])
VlnPlot(dataObject,
        features = cluster7$gene[1:10],
        cols = color.panel,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
cluster7$gene[1:10]
```

## Cluster 8 - oligo
```{r cluster8}
count_per_cluster[,c(1,9)]
DimPlot(object = subset(dataObject, seurat_clusters == "8"),
        reduction = "umap", 
        label = TRUE,
        label.box = TRUE,
        label.size = 3,
        repel = TRUE,
        cols = color.panel[9])
VlnPlot(dataObject,
        features = cluster8$gene[1:10],
        cols = color.panel,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
cluster8$gene[1:10]
```

## Cluster 9 - astrocyte with VCAN
```{r cluster9}
count_per_cluster[,c(1,10)]
DimPlot(object = subset(dataObject, seurat_clusters == "9"),
        reduction = "umap", 
        label = TRUE,
        label.box = TRUE,
        label.size = 3,
        repel = TRUE,
        cols = color.panel[10])
VlnPlot(dataObject,
        features = cluster9$gene[1:10],
        cols = color.panel,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
cluster9$gene[1:10]

FeaturePlot(subset(dataObject, seurat_clusters == "9"),
              reduction = "umap",
              features = c("VCAN", "MOG", "AQP4", "RBFOX3"))
```

## Cluster 10 - interneuron
```{r cluster10}
count_per_cluster[,c(1,11)]
DimPlot(object = subset(dataObject, seurat_clusters == "10"),
        reduction = "umap", 
        label = TRUE,
        label.box = TRUE,
        label.size = 3,
        repel = TRUE,
        cols = color.panel[11])
VlnPlot(dataObject,
        features = cluster10$gene[1:10],
        cols = color.panel,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
cluster10$gene[1:10]

FeaturePlot(subset(dataObject, seurat_clusters == "10"),
              reduction = "umap",
              features = c("GAD1", "RBFOX3"))
```

## Cluster 11 - neuron
```{r cluster11}
count_per_cluster[,c(1,12)]
DimPlot(object = subset(dataObject, seurat_clusters == "11"),
        reduction = "umap", 
        label = TRUE,
        label.box = TRUE,
        label.size = 3,
        repel = TRUE,
        cols = color.panel[12])
VlnPlot(dataObject,
        features = cluster11$gene[1:10],
        cols = color.panel,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
cluster11$gene[1:10]

FeaturePlot(subset(dataObject, seurat_clusters == "11"),
              reduction = "umap",
              features = c("GAD1", "RBFOX3"))
```

## Cluster 12 - interneuron
```{r cluster12}
count_per_cluster[,c(1,13)]
DimPlot(object = subset(dataObject, seurat_clusters == "12"),
        reduction = "umap", 
        label = TRUE,
        label.box = TRUE,
        label.size = 3,
        repel = TRUE,
        cols = color.panel[13])
VlnPlot(dataObject,
        features = cluster12$gene[1:10],
        cols = color.panel,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
cluster12$gene[1:10]
```

## Cluster 13 - interneuron
```{r cluster13}
count_per_cluster[,c(1,14)]
DimPlot(object = subset(dataObject, seurat_clusters == "13"),
        reduction = "umap", 
        label = TRUE,
        label.box = TRUE,
        label.size = 3,
        repel = TRUE,
        cols = color.panel[14])
VlnPlot(dataObject,
        features = cluster13$gene[1:10],
        cols = color.panel,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
cluster13$gene[1:10]
```

## Cluster 14 - neuron
```{r cluster14}
count_per_cluster[,c(1,15)]
DimPlot(object = subset(dataObject, seurat_clusters == "14"),
        reduction = "umap", 
        label = TRUE,
        label.box = TRUE,
        label.size = 3,
        repel = TRUE,
        cols = color.panel[15])
VlnPlot(dataObject,
        features = cluster14$gene[1:10],
        cols = color.panel,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
cluster14$gene[1:10]
```

## Cluster 15 - opc
```{r cluster15}
count_per_cluster[,c(1,16)]
DimPlot(object = subset(dataObject, seurat_clusters == "15"),
        reduction = "umap", 
        label = TRUE,
        label.box = TRUE,
        label.size = 3,
        repel = TRUE,
        cols = color.panel[16])
VlnPlot(dataObject,
        features = cluster15$gene[1:10],
        cols = color.panel,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
cluster15$gene[1:10]
```

## Cluster 16 - interneuron
```{r cluster16}
count_per_cluster[,c(1,17)]
DimPlot(object = subset(dataObject, seurat_clusters == "16"),
        reduction = "umap", 
        label = TRUE,
        label.box = TRUE,
        label.size = 3,
        repel = TRUE,
        cols = color.panel[17])
VlnPlot(dataObject,
        features = cluster16$gene[1:10],
        cols = color.panel,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
cluster16$gene[1:10]
```

## Cluster 17 - interneuron
```{r cluster17}
count_per_cluster[,c(1,18)]
DimPlot(object = subset(dataObject, seurat_clusters == "17"),
        reduction = "umap", 
        label = TRUE,
        label.box = TRUE,
        label.size = 3,
        repel = TRUE,
        cols = color.panel[18])
VlnPlot(dataObject,
        features = cluster17$gene[1:10],
        cols = color.panel,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
cluster17$gene[1:10]
```

## Cluster 18 - neuron
```{r cluster18}
count_per_cluster[,c(1,19)]
DimPlot(object = subset(dataObject, seurat_clusters == "18"),
        reduction = "umap", 
        label = TRUE,
        label.box = TRUE,
        label.size = 3,
        repel = TRUE,
        cols = color.panel[19])
VlnPlot(dataObject,
        features = cluster18$gene[1:10],
        cols = color.panel,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
cluster18$gene[1:10]
```


## Cluster 19 - neuron
```{r cluster19}
count_per_cluster[,c(1,20)]
DimPlot(object = subset(dataObject, seurat_clusters == "19"),
        reduction = "umap", 
        label = TRUE,
        label.box = TRUE,
        label.size = 3,
        repel = TRUE,
        cols = color.panel[20])
VlnPlot(dataObject,
        features = cluster19$gene[1:10],
        cols = color.panel,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
cluster19$gene[1:10]
```


## Cluster 20 - oligo
```{r cluster17}
count_per_cluster[,c(1,21)]
DimPlot(object = subset(dataObject, seurat_clusters == "20"),
        reduction = "umap", 
        label = TRUE,
        label.box = TRUE,
        label.size = 3,
        repel = TRUE,
        cols = color.panel[21])
VlnPlot(dataObject,
        features = cluster20$gene[1:10],
        cols = color.panel,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
cluster20$gene[1:10]
```

## Cluster 21 - neuron
```{r cluster21}
count_per_cluster[,c(1,22)]
DimPlot(object = subset(dataObject, seurat_clusters == "21"),
        reduction = "umap", 
        label = TRUE,
        label.box = TRUE,
        label.size = 3,
        repel = TRUE,
        cols = color.panel[22])
VlnPlot(dataObject,
        features = cluster21$gene[1:10],
        cols = color.panel,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
cluster21$gene[1:10]
```

## Cluster 22 - mural
```{r cluster22}
count_per_cluster[,c(1,23)]
DimPlot(object = subset(dataObject, seurat_clusters == "22"),
        reduction = "umap", 
        label = TRUE,
        label.box = TRUE,
        label.size = 3,
        repel = TRUE,
        cols = color.panel[23])
VlnPlot(dataObject,
        features = cluster22$gene[1:10],
        cols = color.panel,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
cluster22$gene[1:10]
```

## Cluster 23 - fibroblast
```{r cluster23}
count_per_cluster[,c(1,24)]
DimPlot(object = subset(dataObject, seurat_clusters == "23"),
        reduction = "umap", 
        label = TRUE,
        label.box = TRUE,
        label.size = 3,
        repel = TRUE,
        cols = color.panel[24])
VlnPlot(dataObject,
        features = cluster23$gene[1:10],
        cols = color.panel,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
cluster23$gene[1:10]
```

## Cluster 24 - oligo
```{r cluster24}
count_per_cluster[,c(1,25)]
DimPlot(object = subset(dataObject, seurat_clusters == "24"),
        reduction = "umap", 
        label = TRUE,
        label.box = TRUE,
        label.size = 3,
        repel = TRUE,
        cols = color.panel[25])
VlnPlot(dataObject,
        features = cluster24$gene[1:10],
        cols = color.panel,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
cluster24$gene[1:10]
```

## Cluster 25 - interneuron
```{r cluster25}
count_per_cluster[,c(1,26)]
DimPlot(object = subset(dataObject, seurat_clusters == "25"),
        reduction = "umap", 
        label = TRUE,
        label.box = TRUE,
        label.size = 3,
        repel = TRUE,
        cols = color.panel[26])
VlnPlot(dataObject,
        features = cluster25$gene[1:10],
        cols = color.panel,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
cluster25$gene[1:10]
```

## Cluster 26 - neuron
```{r cluster26}
count_per_cluster[,c(1,27)]
DimPlot(object = subset(dataObject, seurat_clusters == "26"),
        reduction = "umap", 
        label = TRUE,
        label.box = TRUE,
        label.size = 3,
        repel = TRUE,
        cols = color.panel[27])
VlnPlot(dataObject,
        features = cluster26$gene[1:10],
        cols = color.panel,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
cluster26$gene[1:10]
```

## Cluster 27 - interneuron
```{r cluster27}
count_per_cluster[,c(1,28)]
DimPlot(object = subset(dataObject, seurat_clusters == "27"),
        reduction = "umap", 
        label = TRUE,
        label.box = TRUE,
        label.size = 3,
        repel = TRUE,
        cols = color.panel[28])
VlnPlot(dataObject,
        features = cluster27$gene[1:10],
        cols = color.panel,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
cluster27$gene[1:10]

FeaturePlot(subset(dataObject, seurat_clusters == "27"),
              reduction = "umap",
              features = c("GAD1", "RBFOX3"))
```

## Cluster 28 - endothelial
```{r cluster28}
count_per_cluster[,c(1,29)]
DimPlot(object = subset(dataObject, seurat_clusters == "28"),
        reduction = "umap", 
        label = TRUE,
        label.box = TRUE,
        label.size = 3,
        repel = TRUE,
        cols = color.panel[29])
VlnPlot(dataObject,
        features = cluster28$gene[1:10],
        cols = color.panel,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
cluster28$gene[1:10]
```

## Cluster 29 - NOISE
```{r cluster29}
count_per_cluster[,c(1,30)]
DimPlot(object = subset(dataObject, seurat_clusters == "29"),
        reduction = "umap", 
        label = TRUE,
        label.box = TRUE,
        label.size = 3,
        repel = TRUE,
        cols = color.panel[30])
VlnPlot(dataObject,
        features = cluster29$gene[1:10],
        cols = color.panel,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
cluster29$gene[1:10]

FeaturePlot(object = subset(dataObject, seurat_clusters == "29"),
              reduction = "umap",
              features = c("TYROBP", "MOG", "AQP4", "RBFOX3"))
```

## Cluster 30 - neuron
```{r cluster30}
count_per_cluster[,c(1,31)]
DimPlot(object = subset(dataObject, seurat_clusters == "30"),
        reduction = "umap", 
        label = TRUE,
        label.box = TRUE,
        label.size = 3,
        repel = TRUE,
        cols = color.panel[31])
VlnPlot(dataObject,
        features = cluster30$gene[1:10],
        cols = color.panel,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
cluster30$gene[1:10]

FeaturePlot(object = subset(dataObject, seurat_clusters == "30"),
              reduction = "umap",
              features = c("FLT1", "MOG", "AQP4", "RBFOX3"))
```

## Cluster 31 - neuron
```{r cluster31}
count_per_cluster[,c(1,32)]
DimPlot(object = subset(dataObject, seurat_clusters == "31"),
        reduction = "umap", 
        label = TRUE,
        label.box = TRUE,
        label.size = 3,
        repel = TRUE,
        cols = color.panel[32])
VlnPlot(dataObject,
        features = cluster31$gene[1:10],
        cols = color.panel,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
cluster31$gene[1:10]

FeaturePlot(object = subset(dataObject, seurat_clusters == "31"),
              reduction = "umap",
              features = c("GAD1", "MOG", "AQP4", "RBFOX3"))
```
## Cluster 32 - neuron
```{r cluster32}
count_per_cluster[,c(1,32)]
DimPlot(object = subset(dataObject, seurat_clusters == "32"),
        reduction = "umap", 
        label = TRUE,
        label.box = TRUE,
        label.size = 3,
        repel = TRUE,
        cols = color.panel[33])
VlnPlot(dataObject,
        features = cluster32$gene[1:10],
        cols = color.panel,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
cluster32$gene[1:10]

FeaturePlot(object = subset(dataObject, seurat_clusters == "32"),
              reduction = "umap",
              features = c("GAD1", "RBFOX3"))
```
## Cluster 33 - NOISE
```{r cluster33}
count_per_cluster[,c(1,33)]
DimPlot(object = subset(dataObject, seurat_clusters == "33"),
        reduction = "umap", 
        label = TRUE,
        label.box = TRUE,
        label.size = 3,
        repel = TRUE,
        cols = color.panel[34])
VlnPlot(dataObject,
        features = cluster33$gene[1:10],
        cols = color.panel,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
cluster33$gene[1:10]

FeaturePlot(object = subset(dataObject, seurat_clusters == "33"),
              reduction = "umap",
              features = c("GAD1", "RBFOX3", "MOG"))
```

## Cluster 34 - opc
```{r cluster34}
count_per_cluster[,c(1,34)]
DimPlot(object = subset(dataObject, seurat_clusters == "34"),
        reduction = "umap", 
        label = TRUE,
        label.box = TRUE,
        label.size = 3,
        repel = TRUE,
        cols = color.panel[35])  # color.panel is one index up from cluster
VlnPlot(dataObject,
        features = cluster34$gene[1:10],
        cols = color.panel,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
cluster34$gene[1:10]

FeaturePlot(object = subset(dataObject, seurat_clusters == "34"),
              reduction = "umap",
              features = c("FLT1", "RBFOX3", "MOG"))
```
## Cluster 35 - NOISE
```{r cluster35}
count_per_cluster[,c(1,35)]
DimPlot(object = subset(dataObject, seurat_clusters == "35"),
        reduction = "umap", 
        label = TRUE,
        label.box = TRUE,
        label.size = 3,
        repel = TRUE,
        cols = color.panel[36])  # color.panel is one index up from cluster
VlnPlot(dataObject,
        features = cluster35$gene[1:10],
        cols = color.panel,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
cluster35$gene[1:10]
```

## Cluster 36 - interneuron
```{r cluster36}
count_per_cluster[,c(1,36)]
DimPlot(object = subset(dataObject, seurat_clusters == "36"),
        reduction = "umap", 
        label = TRUE,
        label.box = TRUE,
        label.size = 3,
        repel = TRUE,
        cols = color.panel[37])  # color.panel is one index up from cluster
VlnPlot(dataObject,
        features = cluster36$gene[1:10],
        cols = color.panel,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
cluster36$gene[1:10]

FeaturePlot(object = subset(dataObject, seurat_clusters == "36"),
              reduction = "umap",
              features = c("GAD1", "RBFOX3", "MOG"))
```

## Cluster 37 - astrocyte
```{r cluster37}
count_per_cluster[,c(1,37)]
DimPlot(object = subset(dataObject, seurat_clusters == "37"),
        reduction = "umap", 
        label = TRUE,
        label.box = TRUE,
        label.size = 3,
        repel = TRUE,
        cols = color.panel[38])  # color.panel is one index up from cluster
VlnPlot(dataObject,
        features = cluster37$gene[1:10],
        cols = color.panel,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
cluster37$gene[1:10]
```
# Assign identities
## Individual 
```{r assign_individual}
dataObject.annotated <- RenameIdents(object = dataObject, 
                               "0" = "oligodendrocyte",
                               "1" = "oligodendrocyte",
                               "2" = "oligodendrocyte",
                               "3" = "astrocyte",
                               "4" = "opc",
                               "5" = "microglia",
                               "6" = "oligodendrocyte",
                               "7" = "oligodendrocyte",
                               "8" = "oligodendrocyte",
                               "9" = "astrocyte",
                               "10" = "interneuron",
                               "11" = "neuron",
                               "12" = "interneuron",
                               "13" = "interneuron",
                               "14" = "neuron",
                               "15" = "opc",
                               "16" = "interneuron",
                               "17" = "interneuron", 
                               "18" = "neuron",
                               "19" = "neuron", 
                               "20" = "oligodendrocyte",
                               "21" = "neuron",
                               "22" = "mural",
                               "23" = "fibroblast",
                               "24" = "oligodendrocyte",
                               "25" = "interneuron",
                               "26" = "neuron",
                               "27" = "interneuron",
                               "28" = "endothelial", 
                               "29" = "NOISE",
                               "30" = "neuron", 
                               "31" = "interneuron", 
                               "32" = "neuron",
                               "33" = "NOISE",
                               "34" = "opc",
                               "35" = "NOISE", 
                               "36" = "interneuron",
                               "37" = "astrocyte"
                               )
dataObject.annotated$individual_clusters <- factor(Idents(dataObject.annotated))

path <- paste0("../results/UMAP/annotated/",projectID,
               "_UMAP_annotated")
pdf(paste0(path, ".pdf"), width = 8, height = 7)
UMAP_ind <- dittoDimPlot(object = dataObject.annotated,
             var = "individual_clusters",
             reduction.use = "umap",
             do.label = TRUE,
             labels.highlight = TRUE)
UMAP_ind
dev.off()
```



### Nuclei count per cluster
```{r annotated_counts_individual}
count_per_cluster <- FetchData(dataObject.annotated,
                               vars = c("ident", "orig.ident")) %>%
  dplyr::count(ident, orig.ident) %>%
  tidyr::spread(ident, n)
count_per_cluster

count_melt <- reshape2::melt(count_per_cluster)
colnames(count_melt) <- c("ident", "cluster", "number of nuclei")
count_max <- count_melt[which.max(count_melt$`number of nuclei`), ]
count_max_value <- count_max$`number of nuclei`
cellmax <- count_max_value + 25000 # so that the figure doesn't cut off the text
count_bar <- ggplot(count_melt, aes(x = factor(cluster), y = `number of nuclei`, fill = `cluster`)) +
  geom_bar(
    stat = "identity",
    colour = "black",
    width = 1,
    position = position_dodge(width = 0.8)
  ) +
  geom_text(
    aes(label = `number of nuclei`),
    position = position_dodge(width = 0.9),
    vjust = -0.25,
    angle = 45,
    hjust = -.01
  ) +
  theme_classic() + scale_fill_manual(values = color.panel) +
  ggtitle("Number of nuclei per cluster") +  xlab("cluster") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(limits = c(0, cellmax))
count_bar
```

```{r nuclei_count_individual, echo=FALSE}
pdf(
  paste0(
    "../results/UMAP/annotated/",
    projectID,
    "_individual_clusters_nuclei_count.pdf"
  ),
  width = 6,
  height = 5
)
count_bar
dev.off()
```

### DotPlot
```{r dot_individual}
markers.to.plot <-
  c(
"CLU", 
"GFAP", 
"AQP4", 
"GJA1",
"CLDN5",
"ADGRF5",
"FLT1",
"COL1A1",
"COL1A2",
"DCN",
"HEXB",
"C1QA",
"C1QB",
"C1QC",
"ITGAM",
"TYROBP",
"P2RY12",
"AIF1",
"RBFOX1",
"RBFOX3", 
"SNAP25",
"SYT1",
"GAD1",
"GAD2",
"PLP1",
"MBP", 
"MOG", 
"OLIG1",
"PDGFRA",
"VCAN",
"TNR",
"ACTA2",
"VTN"
  )


dot_ind <- DotPlot(dataObject.annotated,
                   features = markers.to.plot, 
                   split.by = "group",
                   cols = ATSColors,
                   cluster.idents = TRUE,
                   dot.scale = 8) + RotatedAxis()
dot_ind
```
```{r}
# Remove sample
metadata <- subset(metadata, Sample_ID != "LBD_AS_F4")
metadata$sampleID <- factor(metadata$Sample_ID, levels = c(metadata$Sample_ID))
samples <- metadata$sampleID 
sex_order <- factor(metadata$sex_inferred, levels = unique(metadata$sex_inferred))
disease_order <- factor(metadata$TYPE, levels = c("CONTROL", "AD_AT", "LBD_S", "LBD_AS", "LBD_ATS"))

metadata <- metadata %>%
  mutate(sampleID = gsub(".*_(\\d+)_.*_(BR_Nuclei).*", "\\2_\\1", Lane.Name))
samples <- metadata$sampleID 

# sampleID with disease_order
order <- metadata %>%
  arrange(disease_order) %>%
  dplyr::select(TYPE, sampleID, Sample_ID)
write.table(order, "order.txt", quote = F, row.names = F, sep = "\t")
samples <- order$sampleID
disease_order <- order$TYPE
sample_order <- factor(order$Sample_ID, levels = order$Sample_ID)
```

```{r save_dot_individual, echo=FALSE}
pdf(
  paste0(
    "../results/dot_plot/",
    projectID,
    "_clusters_DotPlot_annotation.pdf"
  ),
  width = 14,
  height = 5
)
dot_ind
dev.off()

dataObject.annotated$group <- disease_order[sample_match]
table(dataObject.annotated$group) 

dot_ind <- DotPlot(dataObject.annotated,
                   features = markers.to.plot, 
                   split.by = "group",
                   cols = c("gray65","gray35", "#4682B4",  "#B4464B", "gray"),
                   cluster.idents = TRUE,
                   dot.scale = 8) + RotatedAxis()


pdf(
  paste0(
    "../results/dot_plot/",
    projectID,
    "_clusters_DotPlot_annotation_by_group.pdf"
  ),
  width = 14,
  height = 12
)
dot_ind
dev.off()
```


### Relative abundance
```{r relative_cell_type}
relative_abundance <- dataObject.annotated@meta.data %>%
  group_by(individual_clusters, orig.ident) %>%
  dplyr::count() %>%
  group_by(orig.ident) %>%
  dplyr::mutate(percent = 100 * n / sum(n)) %>%
  ungroup()


rel_abun <- ggplot(relative_abundance, aes(x = orig.ident, y = percent, fill = individual_clusters)) +
  geom_col() +
  geom_text(aes(label = paste0(round(percent), "%")), 
            position = position_stack(vjust = 0.5), size = 3, color = "white") +
  scale_fill_manual(values = color.panel) +
  ggtitle("Percentage of cell type") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
rel_abun

pdf(
  paste0(
    "../results/UMAP/annotated/",
    projectID,
    "_clusters_relative_abundance.pdf"
  ),
  width = 6,
  height = 8
)
rel_abun
dev.off()
```

# Remove noise
```{r}
#dataObject.annotated$individual_clusters
dataObject.annotated.clean <- subset(dataObject.annotated, cells = WhichCells(dataObject.annotated, idents = setdiff(unique(dataObject.annotated$individual_clusters), c("NOISE"))))
```

# Save RDS 
```{r save_annotations}
saveRDS(dataObject.annotated.clean, paste0("../rObjects/", projectID, "_noise_removed_after_annotation.rds"), compress = FALSE)
```

# Plot with NOISE removed
```{r}
projectID <- "CWOW_cellbender_after_recluster_harm_int_FINAL_clean"
path <- paste0("../results/UMAP/annotated/",projectID,
               "_UMAP_annotated")
pdf(paste0(path, ".pdf"), width = 8, height = 7)
UMAP_ind <- dittoDimPlot(object = dataObject.annotated.clean,
             var = "individual_clusters",
             reduction.use = "umap",
             do.label = TRUE,
             labels.highlight = TRUE)
UMAP_ind
dev.off()
```
### Nuclei count per cluster
```{r annotated_counts_individual}
count_per_cluster <- FetchData(dataObject.annotated.clean,
                               vars = c("ident", "orig.ident")) %>%
  dplyr::count(ident, orig.ident) %>%
  tidyr::spread(ident, n)
count_per_cluster

count_melt <- reshape2::melt(count_per_cluster)
colnames(count_melt) <- c("ident", "cluster", "number of nuclei")
count_max <- count_melt[which.max(count_melt$`number of nuclei`), ]
count_max_value <- count_max$`number of nuclei`
cellmax <- count_max_value + 25000 # so that the figure doesn't cut off the text
count_bar <- ggplot(count_melt, aes(x = factor(cluster), y = `number of nuclei`, fill = `cluster`)) +
  geom_bar(
    stat = "identity",
    colour = "black",
    width = 1,
    position = position_dodge(width = 0.8)
  ) +
  geom_text(
    aes(label = `number of nuclei`),
    position = position_dodge(width = 0.9),
    vjust = -0.25,
    angle = 45,
    hjust = -.01
  ) +
  theme_classic() + scale_fill_manual(values = color.panel) +
  ggtitle("Number of nuclei per cluster") +  xlab("cluster") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(limits = c(0, cellmax))
count_bar
```

```{r nuclei_count_individual, echo=FALSE}
pdf(
  paste0(
    "../results/UMAP/annotated/",
    projectID,
    "_individual_clusters_nuclei_count.pdf"
  ),
  width = 6,
  height = 5
)
count_bar
dev.off()
```

### DotPlot
```{r dot_individual}
dot_ind <- DotPlot(dataObject.annotated.clean,
                   features = markers.to.plot, 
                   cluster.idents = TRUE,
                   dot.scale = 8) + RotatedAxis()
dot_ind
pdf(
  paste0(
    "../results/dot_plot/",
    projectID,
    "_clusters_DotPlot_annotation.pdf"
  ),
  width = 14,
  height = 5
)
dot_ind
dev.off()

dot_ind <- DotPlot(dataObject.annotated.clean,
                   features = markers.to.plot, 
                   split.by = "group",
                   cols = c("gray65","gray35", "#4682B4",  "#B4464B", "gray"),
                   cluster.idents = TRUE,
                   dot.scale = 8) + RotatedAxis()


pdf(
  paste0(
    "../results/dot_plot/",
    projectID,
    "_clusters_DotPlot_annotation_by_group.pdf"
  ),
  width = 14,
  height = 12
)
dot_ind
dev.off()
```

### Relative abundance
```{r relative_cell_type}
relative_abundance <- dataObject.annotated.clean@meta.data %>%
  group_by(individual_clusters, orig.ident) %>%
  dplyr::count() %>%
  group_by(orig.ident) %>%
  dplyr::mutate(percent = 100 * n / sum(n)) %>%
  ungroup()


rel_abun <- ggplot(relative_abundance, aes(x = orig.ident, y = percent, fill = individual_clusters)) +
  geom_col() +
  geom_text(aes(label = paste0(round(percent), "%")), 
            position = position_stack(vjust = 0.5), size = 3, color = "white") +
  scale_fill_manual(values = color.panel) +
  ggtitle("Percentage of cell type") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
rel_abun

pdf(
  paste0(
    "../results/UMAP/annotated/",
    projectID,
    "_clusters_relative_abundance.pdf"
  ),
  width = 6,
  height = 8
)
rel_abun
dev.off()


relative_abundance <- dataObject.annotated.clean@meta.data %>%
  group_by(individual_clusters, group) %>%
  dplyr::count() %>%
  group_by(group) %>%
  dplyr::mutate(percent = 100 * n / sum(n)) %>%
  ungroup()


rel_abun <- ggplot(relative_abundance, aes(x = group, y = percent, fill = individual_clusters)) +
  geom_col() +
  geom_text(aes(label = paste0(round(percent), "%")), 
            position = position_stack(vjust = 0.5), size = 3, color = "white") +
  scale_fill_manual(values = color.panel) +
  ggtitle("Percentage of cell type") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
rel_abun

pdf(
  paste0(
    "../results/UMAP/annotated/",
    projectID,
    "_clusters_relative_abundance_by_group.pdf"
  ),
  width = 8,
  height = 6
)
rel_abun
dev.off()
```


